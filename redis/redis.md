# 一、NoSql概述

NoSQL(NoSQL = Not Only SQL )，作为关系型数据库的补充。

作用：应对基于海量用户和海量数据前提下的数据处理问题。

特征：

- 可扩容，可伸缩
- 大数据量下高性能
- 灵活的数据模型
- 高可用

**解决方案（电商场景）**

1、商品的基本信息（名称，价格，厂商）MySql

2、商品附加信息（描述，详情，评论）MongoDB

3、图片信息（分布式文件系统）

4、搜索关键字（ES、Lucene、solr）

5、热点信息（高频，波段性）Redis、memchche、tair

# 二、Redis

## 1、概念

概念：C语音开发的一个开源的高性能键值对数据库。

特征：

- 数据间没有必然的关联关系
- 内部采用单线程机制进行工作

- 高性能。50个并发执行100000个请求，读速度110000次/s，写速度81000次/s
- 多数据类型支持
  - 字符串类型 	string
  - 列表类型         list
  - 散列类型         hash
  - 集合类型          set
  - 有序集合类型   sorted_set
- 持久化支持，可以进行数据灾难恢复

## 2、Redis的应用

- 为热点数据加速查询（主要场景），如热点商品、热点新闻、热点资讯、推广类等高访问量信息
- 任务队列，如秒杀、抢购、购票排列
- 即时信息查询，如各位排行榜、各类网站访问统计、公交到站信息、在线人数信息（聊天室、网站）、设备信息
- 时效性信息控制，如验证码控制、控票控制
- 分布式数据共享，如分布式集群架构中的session分离
- 消息队列
- 分布式锁

## 3、Redis 的基本操作

### 3.1、信息添加

```shell
127.0.0.1:6379> set age 100
OK
127.0.0.1:6379> get age
"100"
127.0.0.1:6379> get abc
(nil)
```

### 3.2、帮助

```shell
127.0.0.1:6379> help get

  GET key
  summary: Get the value of a key
  since: 1.0.0
  group: string
```

## 4、数据存储类型

### 4.1、作为缓存使用

1、原始业务功能设计

- 秒杀
- 618
- 双11
- 排队购票

2、运营平台监控到的突发高频访问数据

- 突发时政要闻，被强势关注围观

3、高频、复杂的统计数据

- 在线人数
- 投票排行榜

### 4.2 附加功能

1、系统功能优化或升级

- 单服务器升级集群
- `Session` 管理
- `Token` 管理

## 5、Redis 的5种数据类型

**数据存储格式**

- `redis`自身是一个Map，其中所有的数据都采用key：value的形式存储
- 数据类型指的是存储的数据的类型，也就是value部分的类型，key永远都是字符串

### 5.1、string 类型

#### 基本操作

单个数据：

```shell
127.0.0.1:6379> set name zh
OK
127.0.0.1:6379> get name
"zh"
127.0.0.1:6379> del name
(integer) 1
127.0.0.1:6379> del name
(integer) 0
```

多个数据：

```shell
127.0.0.1:6379> mset k1 v1 k2 v2
OK
127.0.0.1:6379> mget k1 k2
1) "v1"
2) "v2"
```

获取字符个数（字符串长度）

```shell
127.0.0.1:6379> set name jack
OK
127.0.0.1:6379> strlen name
(integer) 4
```

追加字符：

```shell
127.0.0.1:6379> append name rose
(integer) 8
127.0.0.1:6379> get name
"jackrose"
127.0.0.1:6379> append k3 v3333
(integer) 5
```

**单数据操作和多数据操作的选择？**

#### 扩展操作

业务场景：

大型企业级应用中，分表操作是基本操作，使用多张表存储同类型数据，但是对应的主键id必须保证统一性，不能重复，如何解决？

- 设置数值数据增加指定范围的值

```shell
127.0.0.1:6379> set num 1
OK
127.0.0.1:6379> incr num
(integer) 2
127.0.0.1:6379> get num
"2"
127.0.0.1:6379> incr num
(integer) 3
127.0.0.1:6379> get num
"3"
```

- 设置数值数据减少指定范围的值

```shell
127.0.0.1:6379> decr num
(integer) 2
127.0.0.1:6379> get num
"2"
```

INCRBY、DECRBY

```shell
127.0.0.1:6379> INCRBY num 10
(integer) 12
127.0.0.1:6379> INCRBYFLOAT num 1.2
"13.199999999999999"
127.0.0.1:6379> get num
"13.199999999999999"

127.0.0.1:6379> DECRBY num 2
(error) ERR value is not an integer or out of range
```

`string`作为数值操作：

- `string`作为`redis`内部存储默认就是一个字符串，当遇到增减类操作incr，decr时会转成数值型进行计算。
- `redis`所有的操作都是原子性的，采用单线程处理所有业务，命令是一个一个执行的，因此无需考虑并发带来的数据影响。
- 注意：按数值进行操作的数据，如果原始数据不能转成数值，或超越了`redis`数值上限范围，将报错。

> - `redis`用于控制数据库表主键id，为数据库表主键提供生成策略，保证数据库表主键唯一性
> - 此方案适用于所有数据库，且支持数据库集群

业务场景：

电商商家开启热门商品推荐，热门商品不能一直处于热门期，每种商品热门期维持3天，3天后自动取消热门。

新闻网站会出现热点新闻，热点新闻最大的特征就是时效性，如何自动控制热点新闻的时效性。

- 设置数据具有指定的生命周期

```shell
127.0.0.1:6379> setex tel 10 1
OK
127.0.0.1:6379> get tel
"1"
127.0.0.1:6379> get tel
(nil)
```

#### string 类型应用场景

业务场景：

主页高频访问信息显示控制，例如新浪微博大V主页显示粉丝数和微博数量

解决方案：

- 在`redis`中为大V用户设定用户信息，以用户主键和属性值作为key，后台设定定时刷新时间

  eg：user:id3506728390:fans ----> 1224432

  ```shell
  127.0.0.1:6379> set user:id00789:fans 1234567
  OK
  127.0.0.1:6379> set user:id00789:blobs 789
  OK
  ```

- 在`redis`中以`json`格式存储大V用户信息，定时刷新

  ```shell
  127.0.0.1:6379> set user:id:00789 {id:00789,blobs:789,fans:1234567}
  OK
  ```

```shell
127.0.0.1:6379> incr user:id:00789:fans
(integer) 1
```

#### key 的设置约定

- 数据库中的热点数据key命名惯例

  ​       表名：主键名：主键值：字段名

  ​       order:      id   :     549   :     name

### 5.2、hash 类型

- 新的存储需求：典型应用存储对象信息
- 存储结构： 一个存储空间保存多个键值对数据
- 底层使用哈希表结构实现数据存储

`hash`存储结构优化：

- 字段数量较少，存储结构有华为类数组结构
- 字段数量较多，存储结构使用`HashMap`结构

#### 基本操作

单个数据：

```shell
127.0.0.1:6379> hset user name zhangsan
(integer) 1
127.0.0.1:6379> hset user age 30
(integer) 1
127.0.0.1:6379> hset user weight 60
(integer) 1
127.0.0.1:6379> hgetall user
1) "name"
2) "zhangsan"
3) "age"
4) "30"
5) "weight"
6) "60"
127.0.0.1:6379> hget user name
"zhangsan"
127.0.0.1:6379> hdel user weight
(integer) 1
127.0.0.1:6379> hgetall user
1) "name"
2) "zhangsan"
3) "age"
4) "30"
```

多个数据：

```shell
127.0.0.1:6379> hmset user name zhangsanfeng weight 77
OK
127.0.0.1:6379> hmget user name age weight
1) "zhangsanfeng"
2) "30"
3) "77"
127.0.0.1:6379> hlen user
(integer) 3
127.0.0.1:6379> HEXISTS user age
(integer) 1
```

#### 扩展操作

- 获取哈希表所有的字段名或字段值

```shell
127.0.0.1:6379> HKEYS user
1) "name"
2) "age"
3) "weight"
127.0.0.1:6379> HVALS user
1) "zhangsanfeng"
2) "30"
3) "77"
```

- 设置指定字段的数值数据增加指定范围的值

```shell
127.0.0.1:6379> HINCRBY user age 1
(integer) 31
```

**注意事项**：

- hash类型下的value只能存储字符串，不允许存储其他数据类型，不存在嵌套现象。如果数据没取到，对应的值为nil
- hash类型十分贴近对象的数据存储形式，并且可以灵活添加删除对象属性。但hash设计初衷不是为了存储大量对象而设计，不可滥用
- hgetall操作可以获取全部属性，如果内部field过多，便利整体数据效率会很低，有可能成为数据范围瓶颈

#### hash类型应用场景

业务场景1：

电商网站购物车设计与实现

![](https://github.com/jackhusky/doc/redis/images/hash结构应用场景.png)

- 仅分析购物车的redis存储模型：添加、浏览、更改数量、删除、清空

解决方案：

- 以客户id作为key，每位客户创建一个hash存储结构存储对应的购物车信息
- 将商品编号作为field，购买数量作为value进行存储
- 添加商品：追加全新的field与value
- 浏览：遍历hash
- 更改数量：自增、自减，设置value的值
- 删除商品：删除field
- 清空：删除key

```shell
127.0.0.1:6379> hmset 001 g01:nums 100
OK
127.0.0.1:6379> hmset g01 info {....}
OK
```

```shell
127.0.0.1:6379> HSET 003 g01:nums 200
(integer) 1
127.0.0.1:6379> HGETALL 003
1) "g01:nums"
2) "200"
127.0.0.1:6379> HSETNX 003 g01:nums 400
(integer) 0
```

业务场景2：

双11活动，销售手机充值卡的商家对30、50、100抢购活动，每种1000张

解决方案：

- 以商家id作为key
- 将参与抢购的商品id作为field
- 将参与抢购的商品数量作为对应的value
- 抢购时使用降值方式控制产品数量

```shell
127.0.0.1:6379> HINCRBY p01 c50 -1
(integer) 999
127.0.0.1:6379> HINCRBY p01 c100 -20
(integer) 980
127.0.0.1:6379> HGETALL p01
1) "c30"
2) "1000"
3) "c50"
4) "999"
5) "c100"
6) "980"
```

> string 存储对象（json）偏读，hash存储对象偏更新

### 5.3、list类型

- 数据存储需求：存储多个数据，并对数据进入存储空间的顺序进行区分
- 需要的存储结构：一个存储空间保存多个数据，且通过数据可以提现进入顺序
- list类型：保存多个数据，底层使用双向链表存储结构实现

#### 基本操作

```shell
127.0.0.1:6379> lpush list1 huawei
(integer) 1
127.0.0.1:6379> lpush list1 apple
(integer) 2
127.0.0.1:6379> lpush list1 microsoft
(integer) 3
127.0.0.1:6379> LRANGE list1 0 2
1) "microsoft"
2) "apple"
3) "huawei"
127.0.0.1:6379> RPUSH list2 a b c
(integer) 3
127.0.0.1:6379> LRANGE list2 0 2
1) "a"
2) "b"
3) "c"
127.0.0.1:6379> LRANGE list1 0 -1
1) "microsoft"
2) "apple"
3) "huawei"
127.0.0.1:6379> LINDEX list1 1
"apple"
127.0.0.1:6379> LLEN list1
(integer) 3
```

获取并移除数据

```shell
127.0.0.1:6379> LPUSH list3 a b c
(integer) 3
127.0.0.1:6379> LPOP list3
"c"
127.0.0.1:6379> LPOP list3
"b"
127.0.0.1:6379> LPOP list3
"a"
```

#### 扩展操作

- 规定时间内获取并移除数据

```shell
127.0.0.1:6379> BLPOP list0 30
```

业务场景：

微信朋友圈点赞，要求按照点赞顺序显示点赞好友信息

如果取消点赞，移除对应好友信息？

- 移除指定数据

  ```shell
  127.0.0.1:6379> rpush 001 a b c d e
  (integer) 5
  127.0.0.1:6379> LRANGE 001 0 -1
  1) "a"
  2) "b"
  3) "c"
  4) "d"
  5) "e"
  127.0.0.1:6379> LREM 001 1 d
  (integer) 1
  127.0.0.1:6379> LRANGE 001 0 -1
  1) "a"
  2) "b"
  3) "c"
  4) "e"
  ```

**注意事项**：

- list中保存的数据都是string类型的，数据总容量是有限的
- list具有索引的概念，但是操作数据时通常以队列的形式进行入队出队操作，或以栈的形式进行入栈出栈操作
- 获取全部数据操作结束索引设置为-1
- list可以对数据进行分页操作，通常第一页的信息来自于list，第二页及更多的信息通过数据库的形式加载

#### list类型应用场景

业务场景：

- twitter、新浪微博中个人用户的关注列表需要按照用户的关注顺序进行展示，粉丝离了表需要将最近关注的粉丝列在前面

- 新闻、资讯类网站如何将最新的新闻或资讯按照发生的时间顺序展示
- 企业运营过程中，系统将产生大量的运营数据，如何保障多台服务器操作日志的同一顺序输出

解决方案：

- 依赖list的数据具有顺序的特征对信息进行管理
- 使用队列模型解决多路信息汇总合并的问题
- 使用栈模型解决最新消息的问题

**应用于最新消息展示**

### 5.4、set类型

- 新的存储需求：存储大量的数据，在查询方面提供更高的效率
- 需要的存储结构：能够保存大量的数据，高效的内部存储机制，便于查询
- set类型：与hash存储结构完全相同，仅存储键，不存储值（nil），并且值是不允许重复的4

#### 基本操作

```shell
127.0.0.1:6379> SADD users zs
(integer) 1
127.0.0.1:6379> SADD users ls
(integer) 1
127.0.0.1:6379> SADD users ww
(integer) 1
127.0.0.1:6379> SMEMBERS users
1) "ww"
2) "ls"
3) "zs"
127.0.0.1:6379> SREM users ww
(integer) 1
127.0.0.1:6379> SMEMBERS users
1) "ls"
2) "zs"
```

```shell
127.0.0.1:6379> SCARD users
(integer) 2
127.0.0.1:6379> SISMEMBER uses zs
(integer) 0
127.0.0.1:6379> SISMEMBER users ww
(integer) 0
```

#### 扩展操作

业务场景1：

每位用户首次使用今日头条时会设置3项爱好的内容，但是后期为了增加用户的活跃度、兴趣点，必须让用户对其他信息类别逐渐产生兴趣，增加客户留存度，如何实现？

业务分析：

- 系统分析出各个分类的最新或最热点信息条目并组织成set集合
- 随机挑选出其中部分信息
- 配合用户关注信息分类中的热点信息组织成展示的全信息集合

解决方案：

- 随机获取集合中指定数量的数据

```shell
127.0.0.1:6379> SADD news n1
(integer) 1
127.0.0.1:6379> SADD news n2
(integer) 1
127.0.0.1:6379> SADD news n3
(integer) 1
127.0.0.1:6379> SADD news n4
(integer) 1
127.0.0.1:6379> SRANDMEMBER news 1
1) "n3"
127.0.0.1:6379> SRANDMEMBER news 1
1) "n2"
127.0.0.1:6379> SCARD news
(integer) 4
127.0.0.1:6379> SRANDMEMBER news 3
1) "n4"
2) "n2"
3) "n3"
```

- 随机获取集合中的某个数据并将数据移除集合

```shell
127.0.0.1:6379> SPOP news
"n3"
127.0.0.1:6379> SMEMBERS news
1) "n4"
2) "n1"
3) "n2"
127.0.0.1:6379> SPOP news 2
1) "n4"
2) "n1"
127.0.0.1:6379> SMEMBERS news
1) "n2"
```

**redis应用于随机推荐类信息检索，例如热点歌单推荐，热点新闻推荐，热卖旅游路线，应用APP推荐，大V推荐等**

业务场景2：

- 脉脉为了促进用户间的交流，保障业务成单率的提升，需要让每位用户拥有大量的好友，事实上职场新人具有更多的职场好友，如何快速积累更多的好友？

- 新浪微博为了增加用户热度，提高用户留存度，需要微博用户在关注更多的人，以此获取更多的信息或热门话题，如何提高用户关注他人的总量？
- QQ新用户入网年龄越来越低，这些用户的朋友圈交际圈非常小，往往集中在一所学校甚至一个班级中，如何帮助用户快速积累好友用户带来更多的活跃度？

- 微信公众号是微信信息流通的渠道之一，增加用户关注的公众号成为提高用户活跃度的一种方式，如何帮助用户积累更多关注的公众号？
- 美团外卖为了提升成单量，必须帮助用户挖掘没事需求，如何推荐给用户最适合自己的美食？